<link rel="import" href="../polymer/polymer.html">


<!--
sc-sse is a non-visual Web Component that receives HTML Server-Sent Events (SSE)
on the client side.

about SSE see:
 https://html.spec.whatwg.org/multipage/comms.html#server-sent-events
 http://www.html5rocks.com/en/tutorials/eventsource/basics/
 
##### Example

    <sc-sse stream="/stream/" event="message" alias="updates"></sc-sse>

@element sc-sse
@blurb non-visual Custom Element that consumes Server-Sent Events (SSE)
@status beta
@homepage http://github.com/siscomando/sc-sse
-->
<polymer-element name="sc-sse" hidden attributes="notitle author stream event alias">
  <script>
    'use strict'
    url= require('url')
  
    Polymer('sc-sse', { 
       /**
       * Fires when an event is received from Server-Sent Event stream.
       *
       *
       * @event sc-sse-response
       */        
      /**
       * The `author` attribute sets an initial author
       *
       * @attribute author
       * @type String
       * @default 'Horacio Ibrahim'
       */ 
      author: 'Horacio Ibrahim', 
      /**
       * The `alias` is name for recognize one of multiple sc-sse element fired.
       *
       * @attribute alias
       * @type String
       * @default default
       */       
      /**
       * The `stream` attribute sets an url to get updates
       *
       * @attribute stream
       * @type String
       * @default ''
       */                   
      publish: {
        stream: '',
        event: 'message',
        alias: 'default'
      },
      ready: function() {
        var stream = this.stream;
        var callback = this.fire;
        var event = this.event;
        var that = this;

        try {
          var source = new EventSource(stream);  
          this.makeRead(source, event, callback, that);
        } catch (x) {
          console.warn('sc-sse: failed to create EventSource ' +x);
        }
      },
      /**
       * `makeRead` opens connection to SSE stream and installs event handler client.
       *
       * 
       * @method makeRead
       * @param source an instance of EventSource
       * @param event an event type 
       * @param callback a callback that works with Polymer objects
       * @param that points to current Polymer element
       */       
      makeRead: function(source, event, callback, that) {
        source.addEventListener(event, function(e) {
          var u= url.parse(that.stream)
          var s= u.protocol +"://" +u.host
          //if (e.origin != that.stream)
          if (e.origin != s)
            console.log("sc-sse: discarding event from alien source " +e.origin)
          else
            callback('sc-sse-response', {response:e.data, alias:that.alias}, that);
        });
      },
    });
  </script>

</polymer-element>

<link rel="import" href="../font-roboto/roboto.html">
<link rel="import" href="../core-icon/core-icon.html">
<link rel="import" href="../paper-item/paper-item.html">

<!--
sc-sse is webcomponent to Server Side Events of HTML5.

##### Example

    <sc-sse stream="/stream/" channel="message" alias="updates"></sc-sse>

@element sc-sse
@blurb Element providing an interface to consume updates by Server Side Events
see more on SSE: http://www.html5rocks.com/en/tutorials/eventsource/basics/?redirect_from_locale=pt.
@status beta
@homepage http://github.com/siscomando/sc-sse
-->
<polymer-element name="sc-sse" hidden attributes="notitle author stream channel alias">
  <script>
    Polymer('sc-sse', {     
      /**
       * The `author` attribute sets an initial author
       *
       * @attribute author
       * @type string
       * @default 'Horacio Ibrahim'
       */ 
      author: 'Horacio Ibrahim', 
      /**
       * The `alias` is name to recognize what sc-sse element fired.
       *
       * @attribute alias
       * @type String
       * @default default
       */       
      /**
       * The `stream` attribute sets an url to get updates (JSON)
       *
       * @attribute stream
       * @type string
       * @default ''
       */                   
      publish: {
        stream: '',
        channel: 'message',
        alias: 'default'
      },
      /* the best place to the constructor for array or object */
      created: function() {
        // initialize but it not is turned public to use by users of the element
        // to turn public to use attributes or publish.
      },
      ready: function() {
        // Ready is a lifecycle callback.
        // You can do setup work in here.
        // More info: http://www.polymer-project.org/docs/polymer/polymer.html#lifecyclemethods
        // simple test alert(this.issueInfo.register);
        var stream = this.stream;
        var callback = this.fire; //this.fire;
        var channel = this.channel;
        var el = this;

        try {
          var source = new EventSource(stream);  
          this.makeRead(source, channel, callback, el);
        } catch (x) {
          console.warn('sc-sse caught an exception trying create new EventSource.');
          console.warn(x);
        }
      },
      makeRead: function(source, channel, callback, onNode) {
        source.addEventListener(channel, function(e) {
          callback('sc-sse-response', {response: e.data, alias: onNode.alias}, onNode);
        });
      },
    });
  </script>

</polymer-element>
